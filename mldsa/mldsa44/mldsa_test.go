package mldsa44_test

import (
	"encoding/hex"
	"fmt"
	"strings"
	"testing"

	"github.com/stretchr/testify/assert"
	"trailofbits.com/ml-dsa/mldsa/mldsa44"
)

func TestKeyGen(t *testing.T) {
	seed, err := hex.DecodeString("4BE7A01A99A5E5BCFE3C06785D8E4EC664082227D86704E9E44862623A05C8B3")
	if err != nil {
		panic(err)
	}
	expect_pk := "ADB0B33464816091F2A95977C67F085FDC24B37854D4DB0A577AE9401E408148D8917D21AA496BB13C60B295CB0A942322A039979828F46A00A4E7DEEBA2BC065216D97D93FD6BC1CD87DD383F18963CE5CFDD71B51DF08086F1415EA512AFAE38CE16E517142D3AE3EDD39496705679466AA9CC3FFA14071DC56244FD1CA4ECA5A1405D5F1FC12F3C5ECACC4B9B021BCA7201C4EA0D670099B7BBD50707164F3F395569990BC6E7E30424B37AB0621DB2954E5996B15670DC4CE03A1497E40465A4C326F1E065E2BFDF1A11ADBA1193522788EEA006B8B1AB296AE1B174C956AE9555180274294CDC19CB4EEFF2AAE1260AB1E03C7CCF8D8A6DF42BA67EEA3228E9E8319821FB06538C71061B5E1D79274816152A4F188FE39743D86ADED0D4E9020D5DBA0596521E8E6A2D50811E6E989AE0D35B4D400A4A4C5C883132F6F3DBD3F6517ECB27745924897FC1141CBFEC4CDD4E871E2D302AE95643D382CAEEF0DED3F1F0646768AB18297EEEC4796CF8A5964F21D55B7B3C1117843B1FAE74D8496302181EE682D076E7858B13BE612EDBB2635FFD51F3964140890F1015C32E3FFBDFB0C76E163169122B35F91E1E29C5B9C92DC40DC738FB7AA44932B937CAFA03EDD7E711EEB19A828034EC3981A2950383F6C6F734BCFFE68D39B71D7F55FE35E4E2299C0A9EDC40B66DB41F7BCA341162DE0350B54E720B9A1AAE0D99DB0A58D052B69EE1A30227439BDFD8C1D4FDBEB4691F9CBD5BB62B47CB0E782BF310E2787B3C255B67708C5C7C751F48BB797069C290493BB8561072EA17B145D26B07209E292FA5ED76CAA31B2D7DB45DDB096D44CDA13ECD03E3547B521DC30CE27D66A288B4059701598D0AD38A33130EBC492BA025D93C58E8BD11873B37ADB1B39066FE83EAD645AE6B04F758470C163AD96AEDA9208420C6E9C274EFBB853563E1CB3660D275F85BB551A2888A1EF05AAF321F65D4EB15DADC93C76A4B52D0C34F556592824968200EBDE652740727E0CB0A6DE0280FCD82CD496A1F5BAF95657BA3C1091FCC36BF7EBE77FC34889EA438A07E92ACEAE453C8EED93D9A70E82CA3B8D06EC9EADB5EAF8B491B665B3903B8C8613A2407A6E5F35F44678B1935663BBA7561096C2E3D502EF0F7A245A52252280016C0B74E3B05D93AEA24CAEBA4D595C31434D99B46F5B5EF4D3A3A625EDD7EB95DCD27C828949699C5E567D7A8512619E14ECC6E1C47CA6567211D1211FC6B949B83783C7CB41762167BF960E935FD853E9ED3BBECCB75E8DFB4E35F854566DCDB300EB0D51B6C22E6EB1D85030DAA5A2FE2BBCC7C2745790860AD48033DA038421051D161739F524BB1C716250623A57F64CB2506DF49C66537C2A46CD0A68D0017BB33CBA4CF37351291D208033768C86799E016A960E6824670FBFF1061087DA8FB74F977110239DED48CFC86A4FC4BAEF220F05AEB0CE34357D7D31D20388FAA307F2D97F593B9E287322A9C329E04328522EA79AAC31CF2765FB334ABD9A1764DA3550968FA693CB84852268170022881CC388745A54A500FACB2B8DF36383E219B99177C3AF51B1E33AF783EFEAE04A0F9845D79AA4A4DD9DDE5CAF7D52D779D59D18F0E0E2B44B634A5D630BE8198AD8B2012C52A7B89F133F09C3E8D21F0AD1137AF095893B966FFC07E8956585FF5C10B123C6A4A5C3367D898ACB128915FE710DF75FA23B4005CAFFEE518C1420403523F0D7EB03696BD21282EB0B1C18A68F70F66837A58453190A06AD0F6E2C28C88183548C7026E2ECC8A5DC5606BBB3679F249B7A2EF79FE70441C03FE0B541016DA53AEDC40CB69A4C952CD075A89D5032380E4A1C3"
	expect_sk := "ADB0B33464816091F2A95977C67F085FDC24B37854D4DB0A577AE9401E408148CF195E6D8DD398713E8F317A5CB4D4F00B2B41F3A9588A8FA4B895D8D8D1C9A11FB72B86F9B4A75132567BE2C45E873D6B5D4A8B8C59F46F2DB81B0857144DB5416B071DF2A8F77D437D47C3BFE11F16FEEFE6C470F46762C881AD19C0884BB3024426889869134586D3B041D3284660C22818230254285203810D04875020262284128E1C462A20034548382911901080405019B385084848CC049004886089A48922050A19876851322AA0044154224EE34029044110021370DBA269E11872C4362619026622960D988425C1026E24233140B8708A18091C10684C120209B72859840C01864DC04262DA846D0926708C166EE24425513868C28425083991908804A3466603110202C864024924509229209581E448618C4808E3182D1CB82942A26C14A2454810710B15442248845842201897690AB530D3300CDC202C61360214338EE4882413B04401062813324C13354DC9A88DD0322D0A11720A2450C280490AA71023236EDBB441C8966C49442118102009286964180918376CC0126EA2808C0B15804BB66C14B24143A0845C385003028EA1C80D1A120E9A208400330190A20508150002A211904806190408C398911CB8008A4265E2484001A0016222841B322808382409456E033511149580A12051513472039205613271C14402C4009009158E48A08800B87152B02902282E5296891A210D11A22D6426718C0012C02662E0301198364461C24C04306CE0184E0CC2259A3022E48824D2C860CAB88C12460464366E18C82D5B34898A226A11B03013848104113162B409E4222C4B202D0A0370DAC261E1308A9C968803456E41240D5C04004C324AE0124A1C250A84364890982CC2B444C34852CB960854342823252624B951183770E2C86418C628C0428DD9A608A3300E00B461CAC2004A3224CCC42CD1244614108209B20989322854126658C869C22649609601D9346010C05159442C81C26903008D9BC64064402ED8440AE31425D3423243224609A2699424888AC48D0441115B94111C3386A4A4611AB54C91220E22B66422976843382EE1B41163908552C028E444295A266601062580466104A42C94045210082401050D1824261830844B042DA0B400D4B490C3084622B131144971D3346148026500A12004448511014D84C23061C28903460022B24593A02D1846480B34885CA284C8A06488A4801298211B496AD8335FA79BF4EC5FEA39F1AC7B7C5854F0FB1985F43D707F567CE12329E43ABDAA9ED4C4B39B6320CA70EBA09A1597717B72ED5B0AEFD46B7C5CBD56D81C3A7A6A9D35EF4E5B87A9FBFD9B384C6B7F43EC296372379B9705788BC7AA36688596A856C024FAB24091F1B2AD8DF64FBABAC18EFF6261A91B454896D23CEB52EF22D93F2BF6D6EC40CEE7FC8312D787AC9D45C6B2C1C52FDDEA9A40DB0AF632792E19E98E04EC442352C988AC86E1BB7D3F63A412F9C7EAB17463D116315D16074C8E6CE01320035B0A6351186F3C7E17E09137CE763AD7C7BE49541B7405BBB8C7026A5FA977BAE1B65B94869EFEF01B77CF173E469A30DA182BD7662AF04818BD623524D5600F23FD5868FA42A45F39672E401E2CF336F41322F823684E6B8799B55FB96EF92F410E23DDA77248DE659F703228F99C8ADF04523C881057344954A81FDBAE000FAE484CD896C4E6543CAE005A0E3DF51E37C0401D106E50DBA14168B5496A3D6DAAB2E010C2DCE215553D10347A9581988D9EDC2583FC10350EC5EF0518B3FA9B54702D93F2A9380697E426C2A017C1DBED6925C44A77509995FE390CABF213D013F2CB9EBD9E09F9A0949803DE285C9C2E6A02CFFE7AEAF013EAAB9B4E82E5D75BBF8E0B8474FF63B2E7BEC2F1AA54EFA0C194B68FD4924636D0E188A31E32A4265B248FC9525ED9462F9BF04B86B443BF5F86AE66647E463646D02D0D8CE201E0C2CE4A3623D0D193A6644634FEBA47A855989FCC8F3DCB81C5F05D9A0FE2E0E4DC094A621F9FF43F1F3E9A8F98CFD4E3C22F5FD7A0DC788A132E6F03427D291EF9D68AF3F3B669A765632DAC5AA38D5735CA370D4EBCA8F06F0F59D6C0D7497D951F9668B534037B027FA5A2FC46DF7AF23BE5616DB20ABACE02EA19BE4B5DE64E09A71A7F90726E38B5A968D7E51F15466DA0AAC9B74CD50C543819D0CEBE879864D1459E4808145F5F29521016BB62B05D8F717B1250CCEF8A4C0296292A8662499D94F7C3FF83D7E17D8D1418EC3F6843EBCBEBB960F9F661E456DADC4843729D3FB396D8E84EE1245672321E4D4C59454B53084439D7662042EC1BD293052E6A44461BD353CF32A4B9FD4E95434554CEA0922CF0D50B5F718DE7B2F01DE189EFB835F4B29AB62B99DC76CCBEC202A4820DF92A820313879F8AF19BFEE5B457BF2987BE486CF3E819A4FCE67E64C6ABB4DD9811A5BD82BE732743C52B1F84AF1B44145C68A96A06EDF5CFB7ADC5BEC55E60F6870BD10DFF603B10E3F454C0C97FB337B12C5DE06938F65D4653F7D1EDDD281E4DDB1B7A5E4753776985EE7215176208B51C1D0138AF1D6A53541F31295121AF682D6FC09F335B88108407AD782094A7ABC664AE1C6B981BF5D646A0CBEEAAA17B2353CAF31E4E1C726E340FF41CFC9E04BC770AB7CC2EB07F010B4298292EFEACA193347CD0BF18370474D0DCD95F5EB45E6AFD4936F8251A1B19521ED7B22679B53C331FA14850D877AA12BEBC68903F8C17C46F7547038D22CDA0D60C912FB9DCB0E4E8FB656B90C41F3820B9093826B090413185934DBC92FA2D209F96BC58B100868C24F8845CB32F2887EE5826F6B88B47E62B55E53989AF385C1DC06815A4F3E73C695694B764166456E46B4C050A61229A87B33DBA7E56CA77D852CC58BAD101085A58C55889A61C09B75BCCD42C8063C7AAC1325C9FCA8F6EE4673B0856C33AA68C0E769EBCAAC47087D62117C0F5D1CAD216FE1D6CA3C46D94C13EEFB81116E2A494324FAF223ABA503804C7368CCDFC942E1309CA8CF55E4D3F77F9A65D846A003DD79E91A36F9A86BEDA5CACF6F8A8D35826D3AB6E93D86FABAC914E84006D6238A99BDEFBFF9390A455ACD8681141B4A6EA6441E62E436CBB65BB1030ABF3C59ED142E2E22544693EB34BBF0B12EFBF01BF6560F1A559D2CA9FDB9D8C96FF421CC1CF34B4FBDC85E8BB0453DD6678ACF400C31B3B40A2D8BD8639BABC12ABF9A3365959F46B8EF06668F362C7EAFA89C6C2C525C7E9E5840B4526FD1FE9575B3A44195F5DD31792490E76E254C6131A98DD77F8D6AC749AC82A98382A4882C42AD7C63DF220DA0FBC46815A21C49F2AD143B76F789E02B6382100DEABDCCDEFC6E74B87724B9582DEEB98E2DA6F3162D2D568F373C87E7B38F858B7121952D78BB0C59A18D76032D8282215634F731C867F8ABDD12003BD4CC1DC7572785AF61535EDAD9E4F25769A40E3917B272659D1348AB8E61242ED8B97D511D57915E583671369B6088B4B4F8823F610D1B5C1578E3FF45DAB7CC47D589A680A1DE60AB9B51F1A531FBA56ED21B3B5EEEE4F7535F306D58323687E203614DC64A689"

	var seed_copy [32]byte
	copy(seed_copy[:], seed[0:32])
	sk, pk := mldsa44.KeyGenInternal(seed_copy)
	actual_sk := strings.ToUpper(hex.EncodeToString(sk.ExpandedBytesForTesting()))
	// First, assert seed-derived values
	assert.Equal(t, expect_sk[0:128], actual_sk[0:128])
	expect_sk_pieces := expect_sk[128:]
	actual_sk_pieces := actual_sk[128:]
	loops := 0
	fail := false
	for len(expect_sk_pieces) > 0 {
		if expect_sk_pieces[0:192] != actual_sk_pieces[0:192] {
			fmt.Printf("- %s\n", expect_sk_pieces[0:192])
			fmt.Printf("+ %s\n", actual_sk_pieces[0:192])
			fmt.Printf("Loop iteration: %d\n", loops)
			// assert.Fail(t, "mismatch")
			fail = true
		}
		// assert.Equal(t, expect_sk_pieces[0:64], actual_sk_pieces[0:64])
		expect_sk_pieces = expect_sk_pieces[192:]
		actual_sk_pieces = actual_sk_pieces[192:]
		loops++
	}
	if fail {
		return
	}

	assert.Equal(t, expect_sk, actual_sk)
	assert.Equal(t, expect_pk, hex.EncodeToString(pk.Bytes()))
}
